## custom-rootfs-creation

Logic to handle both development and release layer IPKs within the same build.
- update_opkg_config – pre rootfs function:
  - Added the support to customise the opkg configuration.
  - Set the layer feeds either to the local build folder or to the remote server depends on the release layer configurations.
- update_install_pkgs_list – pre rootfs function:

Detailed logs will be available in log.do_rootfs<br> 
Path:  [build directory]/[image folder]/1.0-r0/temp/log.do_rootfs

## Resolve package dependencies using ipk

1. Use the option "--no-install-recommends" while installing the IPKs to create the recipe sysroot. 
    - This will reduce the usage of hard disk space and the build time.
2. Use cache mechanism to install the  IPKs to create the recipe sysroot.
    - It will reduce the build time.
3. Generate the packages build meta data from IPK without processing the individual recipe.
    - To create the proper control data for the IPK with correct DEPENDS list.
    - To populate the proper sysroot from IPKs with minimal files.
    - To update the INSANE check instead of removing 'do_package_qa' task.
    - To update the broken dependencies.
4. Create the IPK with proper control data, including all the runtime dependencies.
5. Create the common staging directory for inter layer dependent components.
6. Identify the required files (do_populate_syroot) and create the hardlinks in the recipe sysroot instead of installing all the files.


### Logic :
#### base-deps-resolver.bbclass
  - This will process the DEPENDS and RDEPENDS variables, generate the metadata for the ipk packages, and create the hard links 
      for the required files in the recipe sysroot. This is globally inherited for all the recipes.
#### staging-ipk.bbclass 
  - This will process the meta data generated by "base-deps-resolver", identify the ipk packages, create the staging directory for the interlayer components. It will use the cache mechanism to install the components.
#### staging-ipk-pkgs.bb
  - This will inherit staging-ipk bbclass for installing the packages to resolve the ipk dependencies.
#### kernel-devel.bbclass
  - This will generate the kernel devel package with the required build artifacts. These build artifacts help to compile kernel modules without using the Linux source. This class should inherit the Linux recipe to generate the kernel devel IPK.

### Stages:
#### Recipe parsing [base-deps-resolver]:
  - Identify the ipk packages using layer (ipk) extension and store the details in package metadata.
  - Insert the new package function after "read_shlibdeps" (PACKAGEFUNCS) to update the RDEPENDS data.
  - Add the dependency to "staging-layer-deps" if there is an ipk dependency.
  - Add a pre-function to do_prepare_recipe_sysroot to update the DEPENDS and RDEPENDS metadata to resolve the broken dependencies.

#### do_populate_layer_sysroot [staging-ipk-pkgs]:
  - Before do_populate_sysroot
  - Set the cache directory.
  - Install required ipk packages to the working directory using the options "--host-cache-dir --cache-dir <cache directory>".
  - Create the common layer sysroot directory with the required dirs (usr/lib, lib, usr/include, var/lib/opkg).

  Detailed logs will be available in log.do_populate_layer_sysroot (staging-ipk-pkgs package)<br> 
  Path:  [build directory]/staging-ipk-pkgs/[version]/temp/log.do_populate_layer_sysroot.

#### update_ipk_deps [base-deps-resolver]:
  - prefuncs for do_install_ipk_recipe_sysroot
  - This will update any broken DEPENDS/RDEPENDS ipk packages to the dependency list from the package metadata.

  Detailed logs will be available in log.do_install_ipk_recipe_sysroot <br>
  Path:  [build directory]/[package]/[version]/temp/log.do_install_ipk_recipe_sysroot.

#### do_install_ipk_recipe_sysroot [base-deps-resolver]:

  - After do_prepare_recipe_sysroot and before do_configure.
  - Create the list of dependencies from opkg control data.
  - Find the list of files from the opkg list.
  - Create the hardlink for the files from the common layer sysroot directory to the recipe sysroot directory.

  Detailed logs will be available in log.do_install_ipk_recipe_sysroot<br> 
  Path: [build directory]/[package]/[version]/temp/log.do_install_ipk_recipe_sysroot.

#### do_update_rdeps_ipk [base-deps-resolver]:
  - PACKAGEFUNCS after "read_shlibdeps"
  - Create the list of RDEPENDS from the package metadata.
  - Check the missing shared libs in the IPK.
  - If the missing shared lib is provided by any ipk package, append that to the RDEPENDS list.

  Detailed logs will be available in log.do_package<br>
  Path: [build directory]/[package]/[version]/temp/log.do_package.

### opkg :

|options|Description|
|---|----|
|install [pkgs]|Install package(s)|
|--force-depends|Install/remove despite failed dependencies|
|--no-install-recommends|Do not install any recommended packages|
|--host-cache-dir|Don't place cache in offline root dir|
|--cache-dir [path]|Specify cache directory|
|search [file]|List package providing [file]|
|whatprovides [pkgname]|List package provider name|
